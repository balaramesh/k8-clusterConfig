---
- hosts: localhost
  vars:
    mongo_port: 3002
    mongo_ip: 34.217.22.152
    mongo_user: admin
    mongo_password: password
    mail_user: csc5195191
    mail_password: testaccount
    mail_smtp: smtp.gmail.com
    checkbox_path: /home/ubuntu/checkbox.io
  tasks:

    - name: Install required packages
      apt:
        pkg: '{{item}}'
        state: present
        update_cache: yes
      become: yes
      with_items:
        - npm
        - nodejs
        - nodejs-legacy
        - nginx
        - python3-pip
        - python-pip

    - name: Ensuring previous clone isn't present
      file:
        state: absent
        path: '{{checkbox_path}}'

    - name: Cloning Github repo
      git: repo=https://github.com/chrisparnin/checkbox.io.git clone=yes dest={{checkbox_path}}

    - name: Install Forever node package
      npm:
        name: forever
        state: present
        global: yes
      become: yes

    - name: Install required node packages
      npm:
        path: "{{checkbox_path}}/server-side/site"

    - name: Copy nginx.conf from repo /etc/nginx
      copy: src="{{checkbox_path}}/local-conf/nginx.conf" dest=/etc/nginx/nginx.conf
      become: yes

    - name: Modify the server root in the default file
      replace:
        path: "{{checkbox_path}}/local-conf/default"
        regexp: "root (.)+;"
        replace: "root {{checkbox_path}}/public_html/;"

    - name: Copy default file from repo to nginx folder
      copy: src="{{checkbox_path}}/local-conf/default" dest=/etc/nginx/sites-available/default
      become: yes

    - name: Restart nginx
      service:
       name: nginx
       state: restarted
      become: yes

    # - name: Running server.js
    #   shell:  cd {{checkbox_path}}/server-side/site/; forever stopall; forever start server.js
    #   environment:
    #     MONGO_PORT: "{{mongo_port}}"
    #     MONGO_IP: "{{mongo_ip}}"
    #     MONGO_USER: "{{mongo_user}}"
    #     MONGO_PASSWORD: "{{mongo_password}}"
    #     MAIL_USER: "{{mail_user}}"
    #     MAIL_PASSWORD: "{{mail_password}}"
    #     MAIL_SMTP: "{{mail_smtp}}"
